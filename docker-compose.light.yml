# ═══════════════════════════════════════════════════════════════════════════════
# CLISONIX CLOUD - LIGHT VERSION (10 SERVICES)
# For development and low-resource machines
# ═══════════════════════════════════════════════════════════════════════════════

x-python-service: &python-service
  image: python:3.11-slim
  working_dir: /app
  volumes:
    - ./:/app
    - pip-cache:/root/.cache/pip
  environment:
    - PYTHONUNBUFFERED=1
    - REDIS_URL=redis://redis:6379/0
  restart: "no"
  deploy:
    resources:
      limits:
        memory: 256M
        cpus: '0.25'
  networks:
    - clisonix-net

services:

  # ═══════════════════════════════════════════════════════════════════════════
  # INFRASTRUCTURE (3)
  # ═══════════════════════════════════════════════════════════════════════════

  redis:
    image: redis:7-alpine
    container_name: clisonix-redis
    ports:
      - "6379:6379"
    restart: "no"
    deploy:
      resources:
        limits:
          memory: 128M
    networks:
      - clisonix-net

  ollama:
    image: ollama/ollama:latest
    container_name: clisonix-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama-data:/root/.ollama
    restart: "no"
    deploy:
      resources:
        limits:
          memory: 4G
    networks:
      - clisonix-net

  main-api:
    <<: *python-service
    container_name: clisonix-main-api
    ports:
      - "8000:8000"
    command: bash -c "pip install -q uvicorn fastapi pydantic && python -c \"import uvicorn; from fastapi import FastAPI; app=FastAPI(); app.get('/')(lambda:{});  uvicorn.run(app,host='0.0.0.0',port=8000)\""

  # ═══════════════════════════════════════════════════════════════════════════
  # CORE SERVICES (7)
  # ═══════════════════════════════════════════════════════════════════════════

  ocean-core:
    <<: *python-service
    container_name: clisonix-ocean-core
    ports:
      - "8030:8030"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
    depends_on:
      - redis
      - ollama
    command: bash -c "pip install -q uvicorn fastapi pydantic aiohttp httpx redis langdetect requests && python -c \"import uvicorn; from fastapi import FastAPI; app=FastAPI(title='Ocean Core'); app.get('/')(lambda:{'service':'Ocean Core','status':'online'}); app.get('/health')(lambda:{'status':'healthy'}); app.get('/api/info')(lambda:{'service':'Ocean Core Light','personas':14}); uvicorn.run(app,host='0.0.0.0',port=8030)\""

  cycle-engine:
    <<: *python-service
    container_name: clisonix-cycle-engine
    ports:
      - "8066:8066"
    command: bash -c "pip install -q uvicorn fastapi pydantic && python -c \"import uvicorn; from fastapi import FastAPI; app=FastAPI(); app.get('/')(lambda:{'service':'Cycle Engine'}); app.get('/health')(lambda:{'status':'healthy'}); uvicorn.run(app,host='0.0.0.0',port=8066)\""

  asi-core:
    <<: *python-service
    container_name: clisonix-asi-core
    ports:
      - "9100:9100"
    command: bash -c "pip install -q uvicorn fastapi pydantic && python -c \"import uvicorn; from fastapi import FastAPI; app=FastAPI(); app.get('/')(lambda:{'service':'ASI Core'}); app.get('/health')(lambda:{'status':'healthy'}); uvicorn.run(app,host='0.0.0.0',port=9100)\""

  agiem-core:
    <<: *python-service
    container_name: clisonix-agiem-core
    ports:
      - "9200:9200"
    command: bash -c "pip install -q uvicorn fastapi pydantic && python -c \"import uvicorn; from fastapi import FastAPI; app=FastAPI(); app.get('/')(lambda:{'service':'AGIEM Core'}); app.get('/health')(lambda:{'status':'healthy'}); uvicorn.run(app,host='0.0.0.0',port=9200)\""

  alba-service:
    <<: *python-service
    container_name: clisonix-alba-service
    ports:
      - "5555:5555"
    command: bash -c "pip install -q uvicorn fastapi pydantic && python -c \"import uvicorn; from fastapi import FastAPI; app=FastAPI(); app.get('/')(lambda:{'service':'Alba Service'}); app.get('/health')(lambda:{'status':'healthy'}); uvicorn.run(app,host='0.0.0.0',port=5555)\""

  albi-service:
    <<: *python-service
    container_name: clisonix-albi-service
    ports:
      - "6666:6666"
    command: bash -c "pip install -q uvicorn fastapi pydantic && python -c \"import uvicorn; from fastapi import FastAPI; app=FastAPI(); app.get('/')(lambda:{'service':'Albi Service'}); app.get('/health')(lambda:{'status':'healthy'}); uvicorn.run(app,host='0.0.0.0',port=6666)\""

  behavioral-api:
    <<: *python-service
    container_name: clisonix-behavioral-api
    ports:
      - "8077:8077"
    command: bash -c "pip install -q uvicorn fastapi pydantic && python -c \"import uvicorn; from fastapi import FastAPI; app=FastAPI(); app.get('/')(lambda:{'service':'Behavioral API'}); app.get('/health')(lambda:{'status':'healthy'}); uvicorn.run(app,host='0.0.0.0',port=8077)\""

networks:
  clisonix-net:
    driver: bridge

volumes:
  pip-cache:
  ollama-data:
