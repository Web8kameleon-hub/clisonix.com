<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Earthmind Economy - Zurich Lab</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root { --bg:#0b0f14; --card:#121821; --txt:#e6f0ff; --muted:#8aa1c7; --ok:#2ddb7f; --warn:#ffcf5a; --accent:#5aa8ff; }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--txt);font:14px/1.4 system-ui,Segoe UI,Roboto}
  header{padding:16px 20px;border-bottom:1px solid #1f2a38;display:flex;justify-content:space-between;align-items:center}
  .tag{padding:6px 10px;border-radius:999px;background:#0f1622;border:1px solid #1f2a38;color:var(--muted)}
  .wrap{display:grid;gap:16px;padding:16px;grid-template-columns:1.4fr 1fr}
  .card{background:var(--card);border:1px solid #1f2a38;border-radius:14px;padding:16px;box-shadow:0 10px 30px #0004}
  h2{margin:0 0 12px 0;font-size:16px}
  .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-top:8px}
  .kpi{background:#0f1622;border:1px solid #1f2a38;border-radius:12px;padding:12px}
  .kpi .v{font-weight:700;font-size:18px}
  table{width:100%;border-collapse:collapse;font-size:13px}
  th,td{padding:8px;border-bottom:1px solid #1f2a38}
  th{text-align:left;color:var(--muted);font-weight:600}
  .row{display:flex;gap:8px;align-items:center}
  button{background:var(--accent);border:none;color:#001324;font-weight:700;padding:10px 14px;border-radius:10px;cursor:pointer}
  button.secondary{background:#0f1622;color:var(--txt);border:1px solid #28405e}
  .grid2{display:grid;gap:16px;grid-template-columns:1fr 1fr}
  .muted{color:var(--muted)}
  .footer{padding:12px 16px;color:var(--muted);border-top:1px solid #1f2a38}
  label{display:flex;flex-direction:column;font-size:12px;color:var(--muted)}
  input[type="number"]{margin-top:4px;padding:6px;border-radius:6px;border:1px solid #1f2a38;background:#0f1622;color:var(--txt)}
  @media (max-width: 980px){.wrap{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div class="row">
    <h1 style="font-size:18px;margin:0;">Earthmind Economy - <span id="center">Zurich Lab</span></h1>
    <span class="tag" id="spec">neuro-alignment</span>
  </div>
  <div class="row">
    <button id="simulate">Simulate Value</button>
    <button id="refresh" class="secondary">Refresh</button>
  </div>
</header>

<div class="wrap">
  <div class="card">
    <h2>Lab GDP (NeuroCredit)</h2>
    <div class="kpis">
      <div class="kpi"><div class="t muted">Transactions</div><div class="v" id="txCount">0</div></div>
      <div class="kpi"><div class="t muted">Estimated GDP</div><div class="v" id="gdp">0</div></div>
      <div class="kpi"><div class="t muted">Data Intelligence</div><div class="v" id="sectorDI">0</div></div>
      <div class="kpi"><div class="t muted">API Generation</div><div class="v" id="sectorAPI">0</div></div>
    </div>
    <div class="grid2" style="margin-top:16px;">
      <div class="card" style="background:#0f1622;">
        <h2>Sector Distribution</h2>
        <table id="sectorTable">
          <thead><tr><th>Sector</th><th>Credits</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
      <div class="card" style="background:#0f1622;">
        <h2>Recent Transactions</h2>
        <table id="txTable">
          <thead><tr><th>Time (UTC)</th><th>Value</th><th>Details</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="card">
    <h2>Live Controls</h2>
    <div class="muted">Push simulated cycle values to grow the lab GDP. Wire real cycle hooks when ready.</div>
    <div class="row" style="margin-top:12px;gap:12px;flex-wrap:wrap;align-items:flex-end;">
      <label>ALBA frames <input id="f_alba" type="number" value="3" min="0" /></label>
      <label>ALBI insights <input id="f_albi" type="number" value="2" min="0" /></label>
      <label>JONA validations <input id="f_jona" type="number" value="1" min="0" /></label>
      <label>ASI APIs <input id="f_asi" type="number" value="1" min="0" /></label>
    </div>
    <div class="muted" style="margin-top:10px">API: <code id="apiBase">http://127.0.0.1:9093</code></div>
  </div>
</div>

<div class="footer">
  &copy; 2025 Neurosonix - Earthmind Economy build 0.1. Real-time economy from ALBA to ASI.
</div>

<script>
const API = localStorage.getItem("ECONOMY_API_BASE") || "http://127.0.0.1:9093";
document.getElementById("apiBase").textContent = API;

async function getJSON(url, opts) {
  const res = await fetch(url, opts);
  if (!res.ok) throw new Error("HTTP " + res.status);
  return res.json();
}

function fmt(value) {
  return typeof value === "number" ? value.toLocaleString(undefined, { maximumFractionDigits: 2 }) : value;
}

async function refresh() {
  try {
    const report = await getJSON(API + "/economy/report");
    document.getElementById("center").textContent = report.center || "-";
    document.getElementById("spec").textContent = report.specialization || "-";
    document.getElementById("txCount").textContent = report.transactions_count || 0;
    document.getElementById("gdp").textContent = fmt(report.estimated_gdp_NC) + " NC";
    const sectors = report.sector_distribution || {};
    document.getElementById("sectorDI").textContent = fmt(sectors.data_intelligence || 0);
    document.getElementById("sectorAPI").textContent = fmt(sectors.api_generation || 0);

    const bodySectors = document.querySelector("#sectorTable tbody");
    bodySectors.innerHTML = "";
    Object.entries(sectors).forEach(([name, value]) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${name}</td><td>${fmt(value)}</td>`;
      bodySectors.appendChild(tr);
    });

    const bodyTx = document.querySelector("#txTable tbody");
    bodyTx.innerHTML = "";
    const latest = report.latest_transaction;
    if (latest) {
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${latest.recorded_at}</td><td>${fmt(latest.credits_nc)} NC</td><td class="muted">cycle aggregation</td>`;
      bodyTx.appendChild(tr);
    }
  } catch (err) {
    console.error(err);
    alert("Failed to fetch economy report. Is the Economy API running?");
  }
}

async function simulate() {
  try {
    const payload = {
      alba_frames: Number(document.getElementById("f_alba").value) || 0,
      albi_insights: Number(document.getElementById("f_albi").value) || 0,
      jona_validations: Number(document.getElementById("f_jona").value) || 0,
      asi_apis: Number(document.getElementById("f_asi").value) || 0,
    };
    await getJSON(API + "/economy/compute", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload),
    });
    await refresh();
  } catch (err) {
    console.error(err);
    alert("Simulation failed");
  }
}

document.getElementById("refresh").onclick = refresh;
document.getElementById("simulate").onclick = simulate;

refresh();
setInterval(refresh, 5000);
</script>
</body>
</html>
