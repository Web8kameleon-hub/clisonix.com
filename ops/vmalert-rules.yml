groups:
  - name: clisonix_api_alerts
    interval: 30s
    rules:
      # API AVAILABILITY & PERFORMANCE
      - alert: APIHighErrorRate
        expr: |
          (sum(rate(http_requests_total{status_code=~"5.."}[5m])) / sum(rate(http_requests_total[5m]))) > 0.05
        for: 2m
        labels:
          severity: critical
          service: api
        annotations:
          summary: "API Error Rate High ({{ $value | humanizePercentage }})"
          description: "API is returning 5xx errors at {{ $value | humanizePercentage }} rate"

      - alert: APILatencyHigh
        expr: |
          histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 1.0
        for: 5m
        labels:
          severity: warning
          service: api
        annotations:
          summary: "API Latency High ({{ $value | humanizeDuration }})"
          description: "95th percentile latency is {{ $value | humanizeDuration }}"

      - alert: APIDown
        expr: |
          up{job="api"} == 0
        for: 1m
        labels:
          severity: critical
          service: api
        annotations:
          summary: "API Service Down"
          description: "API service is not responding"

      # AI AGENT PERFORMANCE
      - alert: AIAgentHighLatency
        expr: |
          histogram_quantile(0.95, rate(ai_agent_duration_seconds_bucket[5m])) > 10.0
        for: 3m
        labels:
          severity: warning
          service: ai
        annotations:
          summary: "AI Agent {{ $labels.agent_type }} High Latency"
          description: "95th percentile latency is {{ $value | humanizeDuration }}"

      - alert: AIAgentHighErrorRate
        expr: |
          (sum(rate(ai_agent_executions_total{status="error"}[5m])) by (agent_type) / sum(rate(ai_agent_executions_total[5m])) by (agent_type)) > 0.1
        for: 2m
        labels:
          severity: warning
          service: ai
        annotations:
          summary: "AI Agent {{ $labels.agent_type }} High Error Rate"
          description: "Error rate is {{ $value | humanizePercentage }}"

      # DOCUMENT GENERATION
      - alert: DocumentGenerationErrors
        expr: |
          sum(rate(documents_generated_total{status="error"}[5m])) > 0
        for: 1m
        labels:
          severity: warning
          service: documents
        annotations:
          summary: "Document Generation Errors"
          description: "Documents are failing to generate"

      # DATABASE & CACHE
      - alert: PostgresDown
        expr: |
          up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
          service: postgres
        annotations:
          summary: "PostgreSQL Service Down"
          description: "PostgreSQL database is not responding"

      - alert: RedisDown
        expr: |
          up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
          service: redis
        annotations:
          summary: "Redis Cache Down"
          description: "Redis cache is not responding"

      - alert: ElasticsearchDown
        expr: |
          up{job="elasticsearch"} == 0
        for: 1m
        labels:
          severity: critical
          service: elasticsearch
        annotations:
          summary: "Elasticsearch Down"
          description: "Elasticsearch service is not responding"

      # ORCHESTRATION SERVICES
      - alert: OrchestratorDown
        expr: |
          up{job="orchestrator"} == 0
        for: 1m
        labels:
          severity: critical
          service: orchestrator
        annotations:
          summary: "Orchestrator Service Down"
          description: "Mesh orchestrator is not responding"

      - alert: SaaSServiceDown
        expr: |
          up{tier="saas"} == 0
        for: 2m
        labels:
          severity: critical
          service: saas
        annotations:
          summary: "{{ $labels.service | toUpper }} Service Down"
          description: "{{ $labels.service }} is not responding"

  - name: clisonix_business_alerts
    interval: 1m
    rules:
      # SLA MONITORING
      - alert: APISLAViolation
        expr: |
          (sum(rate(http_requests_total{status_code=~"2.."}[1h])) / sum(rate(http_requests_total[1h]))) < 0.99
        for: 5m
        labels:
          severity: critical
          service: sla
        annotations:
          summary: "API SLA Violation - Availability Below 99%"
          description: "Availability is {{ $value | humanizePercentage }}"

      # RESOURCE USAGE
      - alert: HighMemoryUsage
        expr: |
          (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) > 0.9
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High Memory Usage"
          description: "Memory available is only {{ (1 - $value) | humanizePercentage }}"

      - alert: HighCPUUsage
        expr: |
          (1 - avg(rate(node_cpu_seconds_total{mode="idle"}[5m]))) > 0.8
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "High CPU Usage ({{ $value | humanizePercentage }})"
          description: "CPU usage is high"

      - alert: DiskSpaceLow
        expr: |
          (node_filesystem_avail_bytes{fstype=~"ext4|xfs"} / node_filesystem_size_bytes) < 0.1
        for: 5m
        labels:
          severity: warning
          service: system
        annotations:
          summary: "Low Disk Space on {{ $labels.device }}"
          description: "Less than 10% disk space available"
          severity: critical
        annotations:
          summary: "High API error rate"
          description: "Error rate is {{ $value | humanizePercentage }}"

      - alert: APITimeoutRate
        expr: |
          rate(http_requests_total{status="504"}[5m]) > 0.01
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API timeout rate elevated"
          description: "{{ $value | humanizePercentage }} of requests timing out"

  - name: system_health
    interval: 30s
    rules:
      # CPU & Memory
      - alert: HighCPUUsage
        expr: |
          rate(process_cpu_seconds_total[5m]) > 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage on {{ $labels.instance }}"
          description: "CPU usage is {{ $value | humanizePercentage }}"

      - alert: HighMemoryUsage
        expr: |
          process_resident_memory_bytes / 1024 / 1024 > 1024
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value }}MB"

      - alert: DiskSpaceLow
        expr: |
          node_filesystem_avail_bytes / node_filesystem_size_bytes < 0.1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Low disk space"
          description: "Less than 10% disk space available on {{ $labels.device }}"

  - name: database
    interval: 30s
    rules:
      - alert: DatabaseConnectionPoolExhausted
        expr: |
          db_connection_pool_size - db_connection_pool_available < db_connection_pool_size * 0.9
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Database connection pool nearly exhausted"
          description: "{{ $value | humanize }} connections used"

      - alert: DatabaseSlowQueries
        expr: |
          rate(db_query_duration_seconds_sum{quantile="0.95"}[5m]) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow database queries detected"
          description: "95th percentile query time is {{ $value }}s"

  - name: services
    interval: 30s
    rules:
      - alert: ServiceDown
        expr: |
          up{job=~"alba|albi|jona|orchestrator"} == 0
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Service {{ $labels.job }} is down"
          description: "{{ $labels.instance }} has been unreachable for 2 minutes"

      - alert: ServiceRestarts
        expr: |
          increase(up[15m]) > 2
        labels:
          severity: warning
        annotations:
          summary: "Service {{ $labels.job }} restarted multiple times"
          description: "Service has restarted {{ $value }} times in last 15 minutes"
