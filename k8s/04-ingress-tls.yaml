---
# ═══════════════════════════════════════════════════════════════
# Ingress Controller and Ingress Resources
# ═══════════════════════════════════════════════════════════════

# Ingress for API and Frontend
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: clisonix-ingress
  namespace: clisonix
  labels:
    app: clisonix
  annotations:
    # Nginx annotations
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/rate-limit: "100"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    
    # CORS annotations
    nginx.ingress.kubernetes.io/enable-cors: "true"
    nginx.ingress.kubernetes.io/cors-allow-methods: "GET, POST, PUT, DELETE, OPTIONS, PATCH"
    nginx.ingress.kubernetes.io/cors-allow-credentials: "true"
    
    # Security headers
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "X-Frame-Options: SAMEORIGIN";
      more_set_headers "X-Content-Type-Options: nosniff";
      more_set_headers "X-XSS-Protection: 1; mode=block";
      more_set_headers "Referrer-Policy: strict-origin-when-cross-origin";
    
    # Cert manager for automatic SSL
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    
    # Prometheus monitoring
    prometheus.io/probe: "true"

spec:
  ingressClassName: nginx
  
  tls:
    - hosts:
        - clisonix.com
        - api.clisonix.com
        - app.clisonix.com
      secretName: clisonix-tls-cert
  
  rules:
    # API routes
    - host: api.clisonix.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: clisonix-api-service
                port:
                  number: 8000
    
    # Frontend routes
    - host: app.clisonix.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: clisonix-frontend-service
                port:
                  number: 3000
    
    # Main domain - serve frontend
    - host: clisonix.com
      http:
        paths:
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: clisonix-api-service
                port:
                  number: 8000
          - path: /
            pathType: Prefix
            backend:
              service:
                name: clisonix-frontend-service
                port:
                  number: 3000
    
    # Metrics endpoint
    - host: metrics.clisonix.com
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: prometheus-service
                port:
                  number: 9090

---
# Certificate Issuer for Let's Encrypt
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@clisonix.com
    privateKeySecretRef:
      name: letsencrypt-prod-key
    solvers:
      - http01:
          ingress:
            class: nginx

---
# Certificate Issuer for staging (for testing)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging
spec:
  acme:
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: admin@clisonix.com
    privateKeySecretRef:
      name: letsencrypt-staging-key
    solvers:
      - http01:
          ingress:
            class: nginx

---
# Certificate resource (manually triggered)
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: clisonix-cert
  namespace: clisonix
spec:
  secretName: clisonix-tls-cert
  issuerRef:
    name: letsencrypt-prod
    kind: ClusterIssuer
  dnsNames:
    - clisonix.com
    - "*.clisonix.com"
    - api.clisonix.com
    - app.clisonix.com
    - metrics.clisonix.com

---
# Backend Configuration for API with timeouts
apiVersion: v1
kind: ConfigMap
metadata:
  name: nginx-config
  namespace: clisonix
data:
  api-config.conf: |
    upstream api_backend {
      least_conn;
      server clisonix-api-service:8000;
      keepalive 32;
    }
    
    upstream frontend_backend {
      server clisonix-frontend-service:3000;
      keepalive 32;
    }
    
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=1g inactive=60m use_temp_path=off;

---
# Gateway (alternative to Ingress - Kubernetes 1.20+)
apiVersion: gateway.networking.k8s.io/v1beta1
kind: Gateway
metadata:
  name: clisonix-gateway
  namespace: clisonix
spec:
  gatewayClassName: nginx
  listeners:
    - name: http
      port: 80
      protocol: HTTP
      allowedRoutes:
        namespaces:
          from: Same
    - name: https
      port: 443
      protocol: HTTPS
      tls:
        mode: Terminate
        certificateRefs:
          - name: clisonix-tls-cert
      allowedRoutes:
        namespaces:
          from: Same

---
# HTTP Route for API
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: api-route
  namespace: clisonix
spec:
  parentRefs:
    - name: clisonix-gateway
  hostnames:
    - "api.clisonix.com"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /api
      backendRefs:
        - name: clisonix-api-service
          port: 8000
      timeouts:
        request: 30s
        backendRequest: 30s

---
# HTTP Route for Frontend
apiVersion: gateway.networking.k8s.io/v1beta1
kind: HTTPRoute
metadata:
  name: frontend-route
  namespace: clisonix
spec:
  parentRefs:
    - name: clisonix-gateway
  hostnames:
    - "app.clisonix.com"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: clisonix-frontend-service
          port: 3000
