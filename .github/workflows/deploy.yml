# =============================================================================
# CLISONIX CLOUD - UNIFIED DEPLOYMENT PIPELINE
# =============================================================================
# Deploys to Hetzner Kubernetes with optional Helm or raw K8s manifests
# 
# Triggers:
#   - Push to main (auto-deploy)
#   - Manual dispatch (select environment & method)
# =============================================================================

name: "ðŸš€ Deploy to Kubernetes"

on:
  push:
    branches: [ main ]
    paths:
      - 'apps/**'
      - 'ocean-core/**'
      - 'Dockerfile'
      - 'deploy/kubernetes/**'
      - 'helm/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      deploy_method:
        description: 'Deployment method'
        required: true
        default: 'kubectl'
        type: choice
        options:
          - kubectl
          - helm

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  # Must be lowercase for Docker - github.repository can have uppercase
  IMAGE_NAME: ${{ github.repository_owner }}/${{ github.event.repository.name }}

jobs:
  # =========================================================================
  # BUILD & PUSH DOCKER IMAGE
  # =========================================================================
  build-and-push:
    name: "ðŸ³ Build & Push Image"
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.tags }}
      image_name: ${{ steps.lowercase.outputs.image_name }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Convert repository name to lowercase
        id: lowercase
        run: |
          echo "image_name=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.lowercase.outputs.image_name }}
          tags: |
            type=sha,prefix={{branch}}-
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # =========================================================================
  # DEPLOY WITH KUBECTL (Default)
  # =========================================================================
  deploy-kubectl:
    name: "â˜¸ï¸ Deploy with kubectl"
    runs-on: ubuntu-latest
    needs: build-and-push
    if: |
      success() && 
      (github.event_name == 'push' || inputs.deploy_method == 'kubectl')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.28.0'

      - name: Configure kubectl for Hetzner
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.HETZNER_KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Verify cluster connection
        run: |
          kubectl cluster-info
          kubectl get nodes

      - name: Create namespace
        run: |
          NAMESPACE="clisonix-${{ inputs.environment || 'production' }}"
          kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy to Kubernetes
        run: |
          kubectl apply -f deploy/kubernetes/clisonix-deployment.yaml

      - name: Verify deployment
        run: |
          NAMESPACE="clisonix-${{ inputs.environment || 'production' }}"
          kubectl rollout status deployment/clisonix-backend -n $NAMESPACE --timeout=5m
          kubectl rollout status deployment/clisonix-ocean-core -n $NAMESPACE --timeout=5m
          kubectl rollout status deployment/clisonix-frontend -n $NAMESPACE --timeout=5m

  # =========================================================================
  # DEPLOY WITH HELM (Optional)
  # =========================================================================
  deploy-helm:
    name: "â›µ Deploy with Helm"
    runs-on: ubuntu-latest
    needs: build-and-push
    if: |
      success() && 
      github.event_name == 'workflow_dispatch' && 
      inputs.deploy_method == 'helm'
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: 'v3.13.0'

      - name: Configure kubectl
        uses: azure/setup-kubectl@v4

      - name: Create kubeconfig from secrets
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.HETZNER_KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Add Helm repositories
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
          helm repo add grafana https://grafana.github.io/helm-charts
          helm repo update

      - name: Create namespace
        run: |
          kubectl create namespace clisonix-${{ inputs.environment }} --dry-run=client -o yaml | kubectl apply -f -

      - name: Deploy PostgreSQL
        run: |
          helm upgrade --install postgres bitnami/postgresql \
            --namespace clisonix-${{ inputs.environment }} \
            --values ./helm/values-postgres.yaml \
            --set auth.password=${{ secrets.DB_PASSWORD || 'changeme' }}

      - name: Deploy Redis
        run: |
          helm upgrade --install redis bitnami/redis \
            --namespace clisonix-${{ inputs.environment }} \
            --values ./helm/values-redis.yaml

      - name: Deploy Prometheus Stack
        run: |
          helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
            --namespace clisonix-${{ inputs.environment }} \
            --values ./helm/values-prometheus.yaml

      - name: Deploy Grafana
        run: |
          helm upgrade --install grafana grafana/grafana \
            --namespace clisonix-${{ inputs.environment }} \
            --values ./helm/values-grafana.yaml \
            --set adminPassword=${{ secrets.GRAFANA_PASSWORD || 'admin' }}

      - name: Deploy Clisonix Application
        run: |
          helm upgrade --install clisonix ./helm/clisonix \
            --namespace clisonix-${{ inputs.environment }} \
            --values ./helm/values-${{ inputs.environment }}.yaml \
            --set image.tag=${{ needs.build-and-push.outputs.image_tag }}

      - name: Verify deployment
        run: |
          kubectl get pods -n clisonix-${{ inputs.environment }}
          kubectl get services -n clisonix-${{ inputs.environment }}

  # =========================================================================
  # DEPLOYMENT SUMMARY
  # =========================================================================
  summary:
    name: "ðŸ“‹ Deployment Summary"
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-kubectl, deploy-helm]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸš€ Clisonix Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Docker Build | ${{ needs.build-and-push.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â˜¸ï¸ kubectl Deploy | ${{ needs.deploy-kubectl.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â›µ Helm Deploy | ${{ needs.deploy-helm.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Method:** ${{ inputs.deploy_method || 'kubectl' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
