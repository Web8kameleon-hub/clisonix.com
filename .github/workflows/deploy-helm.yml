# =============================================================================
# CLISONIX CLOUD - FULL MICROSERVICES HELM DEPLOYMENT
# =============================================================================
# Deploys ALL 56+ containers to Hetzner Kubernetes
# Server: 46.224.203.89 (ubuntu-16gb-nbg1-1)
#
# Architecture:
# â”œâ”€â”€ DATABASES: postgres, redis, neo4j, victoriametrics
# â”œâ”€â”€ ASI TRINITY: alba, albi, jona, asi
# â”œâ”€â”€ CORE: ocean-core, alphabet-layers, alba-idle, blerina
# â”œâ”€â”€ BINARY: liam, alda
# â”œâ”€â”€ SPECIALISTS: personas (14 modules)
# â”œâ”€â”€ AGIEM: agiem + 8 datasources
# â”œâ”€â”€ LABS: 23 city-named laboratories
# â”œâ”€â”€ SERVICES: api, web, aviation, behavioral, economy, excel, reporting
# â””â”€â”€ INFRASTRUCTURE: saas-api, marketplace
# =============================================================================

name: "â›µ Full Microservices Deploy"

on:
  push:
    branches: [ main ]
    paths:
      - 'docker-compose.microservices.yml'
      - 'Dockerfile*'
      - 'apps/**'
      - 'ocean-core/**'
      - 'services/**'
      - '.github/workflows/deploy-helm.yml'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - staging
          - production
      deploy_scope:
        description: 'Deployment scope'
        required: true
        default: 'full'
        type: choice
        options:
          - full              # All 56+ containers
          - core              # Databases + ASI Trinity + Ocean
          - labs              # 23 Laboratories only
          - datasources       # AGIEM + 8 datasources only

concurrency:
  group: helm-deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read
  packages: write

env:
  REGISTRY: ghcr.io
  # Hardcoded lowercase - github.repository can have uppercase owner
  IMAGE_NAME: ledjanahmati/clisonix-cloud
  HETZNER_IP: 46.224.203.89
  NAMESPACE_PREFIX: clisonix

jobs:
  # =========================================================================
  # BUILD ALL DOCKER IMAGES
  # =========================================================================
  build-images:
    name: "ðŸ³ Build All Images"
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.vars.outputs.short_sha }}
      image_name: ${{ env.IMAGE_NAME }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Convert repository name to lowercase
        id: repo
        run: echo "image_name=${GITHUB_REPOSITORY,,}" >> $GITHUB_OUTPUT

      - name: Set output variables
        id: vars
        run: echo "short_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # -----------------------------------------------------------------------
      # CORE SERVICES
      # -----------------------------------------------------------------------
      - name: Build Backend API
        uses: docker/build-push-action@v6
        with:
          context: ./apps/api
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Frontend Web
        uses: docker/build-push-action@v6
        with:
          context: ./apps/web
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/web:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Ocean Core
        uses: docker/build-push-action@v6
        with:
          context: ./ocean-core
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/ocean-core:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -----------------------------------------------------------------------
      # ASI TRINITY
      # -----------------------------------------------------------------------
      - name: Build ALBA
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.alba
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/alba:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build ALBI
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.albi
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/albi:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build JONA
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.jona
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/jona:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build ASI
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.asi
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/asi:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -----------------------------------------------------------------------
      # BINARY ALGEBRA
      # -----------------------------------------------------------------------
      - name: Build LIAM
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.liam
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/liam:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build ALDA
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.alda
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/alda:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Alphabet Layers
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.alphabet
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/alphabet:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -----------------------------------------------------------------------
      # INTELLIGENCE MODULES
      # -----------------------------------------------------------------------
      - name: Build BLERINA
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.blerina
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/blerina:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Alba-Idle
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.alba-idle
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/alba-idle:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Personas
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.personas
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/personas:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -----------------------------------------------------------------------
      # AGIEM + DATASOURCES
      # -----------------------------------------------------------------------
      - name: Build AGIEM
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.agiem
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/agiem:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Datasource
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.datasource
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/datasource:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      # -----------------------------------------------------------------------
      # LABORATORIES + SERVICES
      # -----------------------------------------------------------------------
      - name: Build Lab
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.lab
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/lab:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build SaaS API
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.saas
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/saas:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Aviation Weather
        uses: docker/build-push-action@v6
        with:
          context: ./services/aviation-weather
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/aviation:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Behavioral Science
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.behavioral
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/behavioral:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build Economy API
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.economy
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/economy:${{ steps.vars.outputs.short_sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # =========================================================================
  # DEPLOY TO HETZNER KUBERNETES
  # =========================================================================
  deploy:
    name: "â›µ Deploy to Hetzner"
    runs-on: ubuntu-latest
    needs: build-images
    timeout-minutes: 60
    environment: ${{ inputs.environment || 'production' }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Try SSH deployment first (for Docker Compose servers)
      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.HETZNER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ env.HETZNER_IP }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy via SSH (Docker Compose)
        id: ssh_deploy
        continue-on-error: true
        run: |
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 root@${{ env.HETZNER_IP }} << 'ENDSSH'
          cd /root/Clisonix-cloud
          echo "ðŸ“¥ Pulling latest code..."
          git pull origin main || true
          echo "ðŸ”„ Restarting core services..."
          docker-compose up -d web api ocean-core alba asi cycle 2>/dev/null || docker compose up -d web api ocean-core alba asi cycle
          echo "âœ… SSH deployment complete"
          docker ps --format 'table {{.Names}}\t{{.Status}}' | head -20
          ENDSSH

      - name: Skip Kubernetes if SSH succeeded
        if: steps.ssh_deploy.outcome == 'success'
        run: |
          echo "âœ… SSH deployment succeeded - skipping Kubernetes deployment"
          echo "SSH_DEPLOYED=true" >> $GITHUB_ENV

      # Kubernetes deployment (only if SSH failed and kubeconfig exists)
      - name: Set up Helm
        if: steps.ssh_deploy.outcome != 'success'
        uses: azure/setup-helm@v4
        with:
          version: 'v3.14.0'

      - name: Set up kubectl
        if: steps.ssh_deploy.outcome != 'success'
        uses: azure/setup-kubectl@v4
        with:
          version: 'v1.29.0'

      - name: Configure kubeconfig
        if: steps.ssh_deploy.outcome != 'success'
        run: |
          mkdir -p $HOME/.kube
          echo "${{ secrets.HETZNER_KUBECONFIG }}" | base64 -d > $HOME/.kube/config
          chmod 600 $HOME/.kube/config

      - name: Verify cluster connection
        if: steps.ssh_deploy.outcome != 'success'
        run: |
          echo "ðŸ”— Connecting to Hetzner cluster..."
          kubectl cluster-info
          kubectl get nodes
          echo "âœ… Cluster connection verified"

      - name: Add Helm repositories
        if: steps.ssh_deploy.outcome != 'success'
        run: |
          helm repo add bitnami https://charts.bitnami.com/bitnami
          helm repo add ingress-nginx https://kubernetes.github.io/ingress-nginx
          helm repo update

      - name: Create namespace
        if: steps.ssh_deploy.outcome != 'success'
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ inputs.environment || 'production' }}"
          kubectl create namespace $NAMESPACE --dry-run=client -o yaml | kubectl apply -f -

      # -----------------------------------------------------------------------
      # DATABASES
      # -----------------------------------------------------------------------
      - name: Deploy PostgreSQL
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ inputs.environment || 'production' }}"
          helm upgrade --install postgres bitnami/postgresql \
            --namespace $NAMESPACE \
            --set auth.postgresPassword=${{ secrets.DB_PASSWORD || 'clisonix' }} \
            --set auth.database=clisonixdb \
            --set primary.persistence.size=20Gi \
            --wait --timeout 5m

      - name: Deploy Redis
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ inputs.environment || 'production' }}"
          helm upgrade --install redis bitnami/redis \
            --namespace $NAMESPACE \
            --set auth.enabled=false \
            --set master.persistence.size=5Gi \
            --wait --timeout 5m

      - name: Deploy Neo4j
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ inputs.environment || 'production' }}"
          kubectl apply -n $NAMESPACE -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: neo4j
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: neo4j
            template:
              metadata:
                labels:
                  app: neo4j
              spec:
                containers:
                - name: neo4j
                  image: neo4j:5-community
                  ports:
                  - containerPort: 7474
                  - containerPort: 7687
                  env:
                  - name: NEO4J_AUTH
                    value: neo4j/clisonix123
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: neo4j
          spec:
            ports:
            - name: http
              port: 7474
            - name: bolt
              port: 7687
            selector:
              app: neo4j
          EOF

      - name: Deploy VictoriaMetrics
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ inputs.environment || 'production' }}"
          kubectl apply -n $NAMESPACE -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: victoriametrics
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: victoriametrics
            template:
              metadata:
                labels:
                  app: victoriametrics
              spec:
                containers:
                - name: victoriametrics
                  image: victoriametrics/victoria-metrics:v1.96.0
                  ports:
                  - containerPort: 8428
                  args:
                  - "-storageDataPath=/victoria-metrics-data"
                  - "-retentionPeriod=12"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: victoriametrics
          spec:
            ports:
            - port: 8428
            selector:
              app: victoriametrics
          EOF

      # -----------------------------------------------------------------------
      # ASI TRINITY
      # -----------------------------------------------------------------------
      - name: Deploy ASI Trinity (Alba, Albi, Jona, ASI)
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ inputs.environment || 'production' }}"
          TAG="${{ needs.build-images.outputs.image_tag }}"
          
          for SERVICE in alba albi jona asi; do
            case $SERVICE in
              alba) PORT=5555 ;;
              albi) PORT=6680 ;;
              jona) PORT=7777 ;;
              asi)  PORT=9094 ;;
            esac
            
            kubectl apply -n $NAMESPACE -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: $SERVICE
            labels:
              app: clisonix
              component: $SERVICE
              role: asi-trinity
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: $SERVICE
            template:
              metadata:
                labels:
                  app: $SERVICE
              spec:
                containers:
                - name: $SERVICE
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/$SERVICE:$TAG
                  ports:
                  - containerPort: $PORT
                  env:
                  - name: REDIS_URL
                    value: "redis://redis-master:6379"
                  - name: POSTGRES_URL
                    value: "postgresql://clisonix:clisonix@postgres-postgresql:5432/clisonixdb"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: $SERVICE
          spec:
            ports:
            - port: $PORT
            selector:
              app: $SERVICE
          EOF
          done
          echo "âœ… ASI Trinity deployed"

      # -----------------------------------------------------------------------
      # BINARY ALGEBRA (LIAM, ALDA, Alphabet)
      # -----------------------------------------------------------------------
      - name: Deploy Binary Algebra (Liam, Alda, Alphabet)
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ inputs.environment || 'production' }}"
          TAG="${{ needs.build-images.outputs.image_tag }}"
          
          # LIAM
          kubectl apply -n $NAMESPACE -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: liam
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: liam
            template:
              metadata:
                labels:
                  app: liam
              spec:
                containers:
                - name: liam
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/liam:$TAG
                  ports:
                  - containerPort: 8062
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: liam
          spec:
            ports:
            - port: 8062
            selector:
              app: liam
          EOF

          # ALDA
          kubectl apply -n $NAMESPACE -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: alda
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: alda
            template:
              metadata:
                labels:
                  app: alda
              spec:
                containers:
                - name: alda
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/alda:$TAG
                  ports:
                  - containerPort: 8063
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: alda
          spec:
            ports:
            - port: 8063
            selector:
              app: alda
          EOF

          # Alphabet Layers
          kubectl apply -n $NAMESPACE -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: alphabet-layers
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: alphabet-layers
            template:
              metadata:
                labels:
                  app: alphabet-layers
              spec:
                containers:
                - name: alphabet
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/alphabet:$TAG
                  ports:
                  - containerPort: 8061
                  env:
                  - name: BINARY_ONLY
                    value: "true"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: alphabet-layers
          spec:
            ports:
            - port: 8061
            selector:
              app: alphabet-layers
          EOF
          echo "âœ… Binary Algebra deployed"

      # -----------------------------------------------------------------------
      # OCEAN CORE + INTELLIGENCE
      # -----------------------------------------------------------------------
      - name: Deploy Ocean Core + Intelligence
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ inputs.environment || 'production' }}"
          TAG="${{ needs.build-images.outputs.image_tag }}"
          
          # Ocean Core
          kubectl apply -n $NAMESPACE -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: ocean-core
          spec:
            replicas: 2
            selector:
              matchLabels:
                app: ocean-core
            template:
              metadata:
                labels:
                  app: ocean-core
              spec:
                containers:
                - name: ocean
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/ocean-core:$TAG
                  ports:
                  - containerPort: 8030
                  resources:
                    requests:
                      memory: "512Mi"
                      cpu: "500m"
                    limits:
                      memory: "2Gi"
                      cpu: "2000m"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: ocean-core
          spec:
            ports:
            - port: 8030
            selector:
              app: ocean-core
          EOF

          # Alba-Idle, Blerina, Personas
          for SERVICE in alba-idle blerina personas; do
            case $SERVICE in
              alba-idle) PORT=8031 ;;
              blerina)   PORT=8035 ;;
              personas)  PORT=9200 ;;
            esac
            
            kubectl apply -n $NAMESPACE -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: $SERVICE
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: $SERVICE
            template:
              metadata:
                labels:
                  app: $SERVICE
              spec:
                containers:
                - name: $SERVICE
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/$SERVICE:$TAG
                  ports:
                  - containerPort: $PORT
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: $SERVICE
          spec:
            ports:
            - port: $PORT
            selector:
              app: $SERVICE
          EOF
          done
          echo "âœ… Ocean + Intelligence deployed"

      # -----------------------------------------------------------------------
      # AGIEM + DATASOURCES (8 Regions)
      # -----------------------------------------------------------------------
      - name: Deploy AGIEM + Datasources
        if: inputs.deploy_scope == 'full' || inputs.deploy_scope == 'datasources' || github.event_name == 'push'
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ inputs.environment || 'production' }}"
          TAG="${{ needs.build-images.outputs.image_tag }}"
          
          # AGIEM
          kubectl apply -n $NAMESPACE -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: agiem
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: agiem
            template:
              metadata:
                labels:
                  app: agiem
              spec:
                containers:
                - name: agiem
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/agiem:$TAG
                  ports:
                  - containerPort: 9300
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: agiem
          spec:
            ports:
            - port: 9300
            selector:
              app: agiem
          EOF

          # 8 Datasources
          REGIONS="europe americas asia-china india africa central-asia oceania middle-east"
          PORT=9301
          for REGION in $REGIONS; do
            kubectl apply -n $NAMESPACE -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: datasource-$REGION
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: datasource-$REGION
            template:
              metadata:
                labels:
                  app: datasource-$REGION
              spec:
                containers:
                - name: datasource
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/datasource:$TAG
                  ports:
                  - containerPort: $PORT
                  env:
                  - name: DATASOURCE_REGION
                    value: "$REGION"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: datasource-$REGION
          spec:
            ports:
            - port: $PORT
            selector:
              app: datasource-$REGION
          EOF
            PORT=$((PORT + 1))
          done
          echo "âœ… AGIEM + 8 Datasources deployed"

      # -----------------------------------------------------------------------
      # 23 LABORATORIES (City-Named)
      # -----------------------------------------------------------------------
      - name: Deploy 23 Laboratories
        if: inputs.deploy_scope == 'full' || inputs.deploy_scope == 'labs' || github.event_name == 'push'
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ inputs.environment || 'production' }}"
          TAG="${{ needs.build-images.outputs.image_tag }}"
          
          LABS="elbasan tirana durres vlore shkoder korce saranda prishtina kostur athens rome zurich vienna budapest ljubljana zagreb beograd sofia bucharest prague istanbul cairo jerusalem"
          PORT=9101
          
          for LAB in $LABS; do
            kubectl apply -n $NAMESPACE -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: lab-$LAB
            labels:
              app: clisonix
              component: laboratory
              city: $LAB
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: lab-$LAB
            template:
              metadata:
                labels:
                  app: lab-$LAB
              spec:
                containers:
                - name: lab
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/lab:$TAG
                  ports:
                  - containerPort: $PORT
                  env:
                  - name: LAB_NAME
                    value: "$LAB"
                  - name: LAB_PORT
                    value: "$PORT"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: lab-$LAB
          spec:
            ports:
            - port: $PORT
            selector:
              app: lab-$LAB
          EOF
            PORT=$((PORT + 1))
          done
          echo "âœ… 23 Laboratories deployed"

      # -----------------------------------------------------------------------
      # SERVICES (API, Web, Aviation, Behavioral, Economy, etc.)
      # -----------------------------------------------------------------------
      - name: Deploy Core Services
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ inputs.environment || 'production' }}"
          TAG="${{ needs.build-images.outputs.image_tag }}"
          
          # API Backend
          kubectl apply -n $NAMESPACE -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: api
          spec:
            replicas: 3
            selector:
              matchLabels:
                app: api
            template:
              metadata:
                labels:
                  app: api
              spec:
                containers:
                - name: api
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/api:$TAG
                  ports:
                  - containerPort: 8000
                  env:
                  - name: DATABASE_URL
                    value: "postgresql://clisonix:clisonix@postgres-postgresql:5432/clisonixdb"
                  - name: REDIS_URL
                    value: "redis://redis-master:6379"
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: api
          spec:
            ports:
            - port: 8000
            selector:
              app: api
          EOF

          # Web Frontend
          kubectl apply -n $NAMESPACE -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: web
          spec:
            replicas: 3
            selector:
              matchLabels:
                app: web
            template:
              metadata:
                labels:
                  app: web
              spec:
                containers:
                - name: web
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/web:$TAG
                  ports:
                  - containerPort: 3000
          ---
          apiVersion: v1
          kind: Service
          metadata:
            name: web
          spec:
            ports:
            - port: 3000
            selector:
              app: web
          EOF

          # Aviation, Behavioral, Economy
          kubectl apply -n $NAMESPACE -f - <<EOF
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: aviation
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: aviation
            template:
              metadata:
                labels:
                  app: aviation
              spec:
                containers:
                - name: aviation
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/aviation:$TAG
                  ports:
                  - containerPort: 8080
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: behavioral
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: behavioral
            template:
              metadata:
                labels:
                  app: behavioral
              spec:
                containers:
                - name: behavioral
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/behavioral:$TAG
                  ports:
                  - containerPort: 8093
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: economy
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: economy
            template:
              metadata:
                labels:
                  app: economy
              spec:
                containers:
                - name: economy
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/economy:$TAG
                  ports:
                  - containerPort: 8091
          ---
          apiVersion: apps/v1
          kind: Deployment
          metadata:
            name: saas-api
          spec:
            replicas: 1
            selector:
              matchLabels:
                app: saas-api
            template:
              metadata:
                labels:
                  app: saas-api
              spec:
                containers:
                - name: saas
                  image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/saas:$TAG
                  ports:
                  - containerPort: 9400
          EOF
          echo "âœ… Core Services deployed"

      # -----------------------------------------------------------------------
      # INGRESS
      # -----------------------------------------------------------------------
      - name: Deploy Ingress
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ inputs.environment || 'production' }}"
          DOMAIN="${{ inputs.environment == 'staging' && 'staging.clisonix.cloud' || 'clisonix.cloud' }}"
          
          helm upgrade --install ingress-nginx ingress-nginx/ingress-nginx \
            --namespace $NAMESPACE \
            --set controller.service.externalTrafficPolicy=Local \
            --wait --timeout 5m

          kubectl apply -n $NAMESPACE -f - <<EOF
          apiVersion: networking.k8s.io/v1
          kind: Ingress
          metadata:
            name: clisonix-ingress
            annotations:
              nginx.ingress.kubernetes.io/ssl-redirect: "true"
          spec:
            ingressClassName: nginx
            rules:
            - host: $DOMAIN
              http:
                paths:
                - path: /
                  pathType: Prefix
                  backend:
                    service:
                      name: web
                      port:
                        number: 3000
                - path: /api
                  pathType: Prefix
                  backend:
                    service:
                      name: api
                      port:
                        number: 8000
                - path: /ocean
                  pathType: Prefix
                  backend:
                    service:
                      name: ocean-core
                      port:
                        number: 8030
          EOF
          echo "âœ… Ingress configured for $DOMAIN"

      # -----------------------------------------------------------------------
      # VERIFICATION
      # -----------------------------------------------------------------------
      - name: Verify All Deployments
        run: |
          NAMESPACE="${{ env.NAMESPACE_PREFIX }}-${{ inputs.environment || 'production' }}"
          echo "ðŸ“Š Deployment Status:"
          echo ""
          kubectl get pods -n $NAMESPACE --no-headers | wc -l
          echo "containers running"
          echo ""
          kubectl get pods -n $NAMESPACE -o wide
          echo ""
          kubectl get services -n $NAMESPACE

  # =========================================================================
  # DEPLOYMENT SUMMARY
  # =========================================================================
  summary:
    name: "ðŸ“‹ Deployment Summary"
    runs-on: ubuntu-latest
    needs: [build-images, deploy]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "## â›µ Clisonix Full Microservices Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ—ï¸ Architecture Deployed" >> $GITHUB_STEP_SUMMARY
          echo "| Category | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—„ï¸ Databases | 4 (Postgres, Redis, Neo4j, VictoriaMetrics) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§  ASI Trinity | 4 (Alba, Albi, Jona, ASI) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¢ Binary Algebra | 3 (Liam, Alda, Alphabet) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒŠ Ocean Intelligence | 4 (Ocean, Alba-Idle, Blerina, Personas) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ AGIEM + Datasources | 9 (AGIEM + 8 regions) |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ›ï¸ Laboratories | 23 (City-named) |" >> $GITHUB_STEP_SUMMARY
          echo "| âš™ï¸ Core Services | 9 (API, Web, Aviation, etc.) |" >> $GITHUB_STEP_SUMMARY
          echo "| **TOTAL** | **56+ containers** |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“Š Build & Deploy Status" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ³ Build Images | ${{ needs.build-images.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| â›µ Deploy | ${{ needs.deploy.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** 46.224.203.89 (Hetzner NÃ¼rnberg)" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Scope:** ${{ inputs.deploy_scope || 'full' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ needs.build-images.outputs.image_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŒ Access Points" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend:** https://clisonix.cloud" >> $GITHUB_STEP_SUMMARY
          echo "- **API:** https://clisonix.cloud/api" >> $GITHUB_STEP_SUMMARY
          echo "- **Ocean:** https://clisonix.cloud/ocean" >> $GITHUB_STEP_SUMMARY
          echo "- **ASI:** https://clisonix.cloud/asi" >> $GITHUB_STEP_SUMMARY
