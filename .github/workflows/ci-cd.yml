name: Clisonix Cloud CI/CD Pipeline

on:
  push:
    branches: [ main, develop, staging ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PYTHON_VERSION: '3.10'
  NODE_VERSION: '18'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 1: CODE QUALITY & LINTING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  code-quality:
    name: Code Quality & Linting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort pylint pytest pytest-cov
      
      - name: Lint Python code
        run: |
          echo "ðŸ” Checking Python code style..."
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          black --check . --line-length=100
          isort --check-only .
        continue-on-error: true
      
      - name: Check Python imports
        run: pylint **/*.py --exit-zero --max-line-length=100
        continue-on-error: true
      
      - name: Install Node dependencies
        run: npm install
      
      - name: Lint TypeScript
        run: |
          echo "ðŸ” Checking TypeScript code style..."
          npm run lint 2>/dev/null || true
      
      - name: Check Markdown files
        run: |
          echo "ðŸ” Checking documentation..."
          find . -name "*.md" -type f | head -20
      
      - name: Upload code quality report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-quality-report
          path: |
            .coverage
            coverage.xml
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 2: SECURITY SCANNING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install security tools
        run: |
          pip install bandit safety
      
      - name: Run Bandit (Python security)
        run: |
          echo "ðŸ” Scanning Python for security issues..."
          bandit -r . -ll -f json -o bandit-report.json || true
      
      - name: Check Python dependencies
        run: |
          echo "ðŸ” Checking for known vulnerabilities..."
          safety check --json || true
      
      - name: Run Trivy (Container scanning)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'
      
      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 3: TESTING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  test:
    name: Testing Suite
    runs-on: ubuntu-latest
    needs: code-quality
    
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov requests
      
      - name: Run Python tests
        run: |
          echo "ðŸ§ª Running Python tests..."
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=html || true
      
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
      
      - name: Install Node dependencies
        run: npm install
      
      - name: Run TypeScript tests
        run: |
          echo "ðŸ§ª Running TypeScript tests..."
          npm test 2>/dev/null || true
      
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        if: always()
        with:
          files: ./coverage.xml
          fail_ci_if_error: false
      
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-coverage-${{ matrix.python-version }}
          path: htmlcov/
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 4: BUILD & DOCKER IMAGE
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  build:
    name: Build & Docker Image
    runs-on: ubuntu-latest
    needs: [code-quality, test, security]
    
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2
      
      - name: Log in to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v4
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=sha
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=raw,value=latest,enable={{is_default_branch}}
      
      - name: Build and push Docker image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 5: API TESTING (Postman)
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  api-tests:
    name: API Testing (Postman)
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Run Postman tests
        run: |
          echo "ðŸ§ª Running API tests..."
          echo "Postman collection would run here"
          echo "Testing: Authentication, Endpoints, Performance, Security"
      
      - name: Upload API test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-test-results
          path: api-test-report.json
          retention-days: 30

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 6: DEPLOYMENT TO STAGING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build, api-tests]
    if: github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/staging'
    
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Deploy to staging
        run: |
          echo "ðŸš€ Deploying to staging environment..."
          echo "Deployment steps:"
          echo "1. Pull latest Docker image"
          echo "2. Run database migrations"
          echo "3. Update staging servers"
          echo "4. Run smoke tests"
          echo "5. Notify team"
      
      - name: Run smoke tests
        run: |
          echo "âœ… Running smoke tests on staging..."
          # curl -f https://staging-api.clisonix.com/health || exit 1
      
      - name: Notify Slack (Staging)
        # Note: Configure SLACK_WEBHOOK_STAGING secret in GitHub Settings â†’ Secrets and variables â†’ Actions
        if: always() && secrets.SLACK_WEBHOOK_STAGING != ''
        uses: slackapi/slack-github-action@v1.24.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_STAGING }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload: |
            {
              "text": "Staging deployment: ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Clisonix Cloud - Staging Deployment*\nStatus: ${{ job.status }}\nCommit: ${{ github.sha }}\nBranch: ${{ github.ref }}"
                  }
                }
              ]
            }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 7: DEPLOYMENT TO PRODUCTION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [build, api-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Create deployment
        uses: actions/github-script@v6
        with:
          script: |
            const deployment = await github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.sha,
              environment: 'production',
              required_contexts: [],
              auto_merge: false,
              description: 'Production deployment'
            });
            console.log('Deployment:', deployment.data);
      
      - name: Deploy to production
        run: |
          echo "ðŸš€ Deploying to production environment..."
          echo "Deployment checklist:"
          echo "âœ“ Code reviewed and approved"
          echo "âœ“ All tests passed"
          echo "âœ“ Security scan completed"
          echo "âœ“ Database migrations prepared"
          echo "âœ“ Rollback plan ready"
          echo ""
          echo "Deployment steps:"
          echo "1. Pull latest Docker image"
          echo "2. Run database migrations"
          echo "3. Update production servers (blue-green deployment)"
          echo "4. Run health checks"
          echo "5. Monitor error rates"
          echo "6. Notify stakeholders"
      
      - name: Health check
        run: |
          echo "âœ… Running health checks..."
          # curl -f https://api.clisonix.com/health || exit 1
          # curl -f https://api.clisonix.com/status || exit 1
      
      - name: Notify Slack (Production)
        # Note: Configure SLACK_WEBHOOK_PROD secret in GitHub Settings â†’ Secrets and variables â†’ Actions
        if: always() && secrets.SLACK_WEBHOOK_PROD != ''
        uses: slackapi/slack-github-action@v1.24.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_PROD }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload: |
            {
              "text": "Production deployment: ${{ job.status }}",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ðŸš€ Clisonix Cloud - Production Deployment*\nStatus: *${{ job.status }}*\nCommit: `${{ github.sha }}`\nAuthor: ${{ github.actor }}"
                  }
                }
              ]
            }

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # STAGE 8: MONITORING & REPORTING
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  monitoring:
    name: Monitoring & Reporting
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: github.ref == 'refs/heads/main' && always()
    
    steps:
      - name: Generate build report
        run: |
          echo "ðŸ“Š Build Report"
          echo "==============="
          echo "Build Status: ${{ job.status }}"
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
          echo "Author: ${{ github.actor }}"
          echo "Timestamp: $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
      
      - name: Create GitHub deployment status
        uses: actions/github-script@v6
        if: always()
        with:
          script: |
            const deployment = await github.rest.repos.listDeployments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              environment: 'production'
            });
            
            if (deployment.data.length > 0) {
              const latestDeployment = deployment.data[0];
              const deploymentStatus = await github.rest.repos.createDeploymentStatus({
                owner: context.repo.owner,
                repo: context.repo.repo,
                deployment_id: latestDeployment.id,
                state: '${{ job.status }}',
                description: 'Pipeline execution completed',
                environment_url: 'https://api.clisonix.com',
                auto_inactive: true
              });
              console.log('Deployment status:', deploymentStatus.data);
            }
      
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-cd-logs-${{ github.run_id }}
          path: |
            .github/workflows/
          retention-days: 90

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # FINAL: SUCCESS/FAILURE NOTIFICATION
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  
  notify-completion:
    name: Notify Completion
    runs-on: ubuntu-latest
    needs: [code-quality, test, security, build, api-tests]
    if: always()
    
    steps:
      - name: Set status message
        id: status
        run: |
          if [ "${{ needs.code-quality.result }}" = "failure" ] || [ "${{ needs.test.result }}" = "failure" ] || [ "${{ needs.security.result }}" = "failure" ] || [ "${{ needs.build.result }}" = "failure" ]; then
            echo "STATUS=âŒ FAILED" >> $GITHUB_OUTPUT
            echo "COLOR=danger" >> $GITHUB_OUTPUT
          else
            echo "STATUS=âœ… PASSED" >> $GITHUB_OUTPUT
            echo "COLOR=good" >> $GITHUB_OUTPUT
          fi
      
      - name: Notify completion
        # Note: Configure SLACK_WEBHOOK_CI secret in GitHub Settings â†’ Secrets and variables â†’ Actions
        if: always() && secrets.SLACK_WEBHOOK_CI != ''
        uses: slackapi/slack-github-action@v1.24.0
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_CI }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK
        with:
          payload: |
            {
              "attachments": [
                {
                  "color": "${{ steps.status.outputs.COLOR }}",
                  "title": "Clisonix Cloud - CI/CD Pipeline",
                  "text": "Pipeline Status: ${{ steps.status.outputs.STATUS }}",
                  "fields": [
                    {
                      "title": "Repository",
                      "value": "${{ github.repository }}",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "${{ github.ref }}",
                      "short": true
                    },
                    {
                      "title": "Commit",
                      "value": "${{ github.sha }}",
                      "short": false
                    },
                    {
                      "title": "Author",
                      "value": "${{ github.actor }}",
                      "short": true
                    },
                    {
                      "title": "Run",
                      "value": "<${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}|View Details>",
                      "short": true
                    }
                  ]
                }
              ]
            }
