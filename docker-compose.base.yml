# =================================================
# DOCKER COMPOSE - BASE CONFIGURATION
# =================================================
# Konfigurime te perbashketa qe perdoren nga te gjitha
# environment (dev, staging, prod)
# Use with: docker-compose -f docker-compose.base.yml -f docker-compose.dev.yml up
# =================================================

version: "3.9"

# =================================================
# YAML ANCHORS - DRY Configuration
# =================================================
x-common-variables: &common-variables
  TZ: Europe/Tirane
  LANG: en_US.UTF-8
  LC_ALL: en_US.UTF-8

x-python-common: &python-common
  <<: *common-variables
  PYTHONUNBUFFERED: "1"
  PYTHONDONTWRITEBYTECODE: "1"
  PYTHONIOENCODING: UTF-8
  PYTHON_VERSION: ${PYTHON_VERSION:-3.13.11}

x-node-common: &node-common
  <<: *common-variables
  NODE_ENV: ${NODE_ENV:-production}
  NODE_VERSION: ${NODE_VERSION:-22.21.1}

x-healthcheck-defaults: &healthcheck-defaults
  interval: 10s
  timeout: 5s
  retries: 5
  start_period: 30s

x-restart-policy: &restart-policy
  restart: unless-stopped

x-logging-defaults: &logging-defaults
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"

# =================================================
# SERVICES BASE CONFIGURATION
# =================================================
services:
  postgres:
    image: postgres:${POSTGRES_VERSION:-16}
    container_name: clisonix-postgres
    environment:
      <<: *common-variables
      POSTGRES_USER: ${POSTGRES_USER:-clisonix}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB:-clisonixdb}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-clisonix}"]
    <<: [*restart-policy, *logging-defaults]

  redis:
    image: redis:${REDIS_VERSION:-7-alpine}
    container_name: clisonix-redis
    command: redis-server ${REDIS_PASSWORD:+--requirepass $REDIS_PASSWORD}
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "redis-cli", "ping"]
    <<: [*restart-policy, *logging-defaults]

  minio:
    image: minio/minio:${MINIO_VERSION:-latest}
    container_name: clisonix-minio
    environment:
      <<: *common-variables
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-clisonix}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    ports:
      - "${MINIO_PORT:-9000}:9000"
      - "${MINIO_CONSOLE_PORT:-9001}:9001"
    <<: [*restart-policy, *logging-defaults]

  victoria-metrics:
    image: victoriametrics/victoria-metrics:${VICTORIA_METRICS_VERSION:-latest}
    container_name: clisonix-victoria-metrics
    environment:
      <<: *common-variables
    command:
      - "-storageDataPath=/victoria-metrics-data"
      - "-retentionPeriod=${METRICS_RETENTION:-90d}"
      - "-memory.allowedPercent=60"
    ports:
      - "${VICTORIA_METRICS_PORT:-8428}:8428"
    volumes:
      - victoria_data:/victoria-metrics-data
    <<: [*restart-policy, *logging-defaults]

  grafana:
    image: grafana/grafana:${GRAFANA_VERSION:-latest}
    container_name: clisonix-grafana
    environment:
      <<: *common-variables
      GF_SECURITY_ADMIN_USER: ${GF_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GF_SECURITY_ADMIN_PASSWORD}
      GF_INSTALL_PLUGINS: ${GF_INSTALL_PLUGINS}
      GF_SERVER_DOMAIN: ${GF_SERVER_DOMAIN:-localhost}
      GF_SERVER_ROOT_URL: ${GF_SERVER_ROOT_URL:-http://localhost:3000}
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./grafana/datasources:/etc/grafana/provisioning/datasources:ro
    ports:
      - "${GRAFANA_PORT:-3000}:3000"
    depends_on:
      - victoria-metrics
    <<: [*restart-policy, *logging-defaults]

  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:${ELASTICSEARCH_VERSION:-8.11.0}
    container_name: clisonix-elasticsearch
    environment:
      <<: *common-variables
      discovery.type: single-node
      ELASTIC_PASSWORD: ${ELASTIC_PASSWORD}
      xpack.security.enabled: ${ES_SECURITY_ENABLED:-true}
      ES_JAVA_OPTS: ${ES_JAVA_OPTS:--Xms512m -Xmx512m}
    volumes:
      - elasticsearch_data:/usr/share/elasticsearch/data
    ports:
      - "${ELASTICSEARCH_PORT:-9200}:9200"
    <<: [*restart-policy, *logging-defaults]

  loki:
    image: grafana/loki:${LOKI_VERSION:-latest}
    container_name: clisonix-loki
    environment:
      <<: *common-variables
    command: -config.file=/etc/loki/local-config.yaml
    ports:
      - "${LOKI_PORT:-3100}:3100"
    volumes:
      - loki_data:/loki
    <<: [*restart-policy, *logging-defaults]

# =================================================
# VOLUMES
# =================================================
volumes:
  postgres_data:
  redis_data:
  minio_data:
  victoria_data:
  grafana_data:
  elasticsearch_data:
  loki_data:

# =================================================
# NETWORKS
# =================================================
networks:
  default:
    name: clisonix-network
    driver: bridge
