services:
  # ==========================
  # DATABASES
  # ==========================
  postgres:
    image: postgres:16-alpine
    container_name: clisonix-postgres
    environment:
      POSTGRES_USER: clisonix
      POSTGRES_PASSWORD: clisonix
      POSTGRES_DB: clisonixdb
    ports:
      - "5432:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U clisonix"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: clisonix-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ==========================
  # ASI TRINITY - ALBA (Analytical Intelligence)
  # ==========================
  alba:
    build:
      context: .
      dockerfile: Dockerfile.alba
    container_name: clisonix-alba
    environment:
      PYTHONUNBUFFERED: "1"
      REDIS_URL: "redis://redis:6379/0"
    ports:
      - "5555:5555"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5555/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # ASI TRINITY - ALBI (Creative Intelligence)
  # ==========================
  albi:
    build:
      context: .
      dockerfile: Dockerfile.albi
    container_name: clisonix-albi
    environment:
      PYTHONUNBUFFERED: "1"
      REDIS_URL: "redis://redis:6379/0"
      PORT: "6680"
    ports:
      - "6680:6680"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6680/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # OLLAMA (LLM Backend)
  # ==========================
  ollama:
    image: ollama/ollama:latest
    container_name: clisonix-ollama
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    environment:
      OLLAMA_HOST: "0.0.0.0"
    healthcheck:
      test: ["CMD-SHELL", "ollama list || exit 0"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

  # ==========================
  # OCEAN-CORE (Knowledge Engine & Curiosity AI)
  # ==========================
  ocean-core:
    build:
      context: ./ocean-core
      dockerfile: Dockerfile
    container_name: clisonix-ocean-core
    environment:
      PYTHONUNBUFFERED: "1"
      OCEAN_PORT: "8030"
      OLLAMA_HOST: "http://clisonix-ollama:11434"
      MODEL: "llama3.1:8b"
      REDIS_URL: "redis://redis:6379/0"
    ports:
      - "8030:8030"
    depends_on:
      ollama:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8030/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # AVIATION WEATHER API (Microservice)
  # ==========================
  aviation:
    build:
      context: ./services/aviation-weather
      dockerfile: Dockerfile
    container_name: clisonix-aviation
    environment:
      PYTHONUNBUFFERED: "1"
      AVIATION_PORT: "8080"
      AVWX_API_KEY: "${AVWX_API_KEY:-}"
      CHECKWX_API_KEY: "${CHECKWX_API_KEY:-}"
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # API BACKEND (JONA - Coordinator)
  # ==========================
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    container_name: clisonix-api
    environment:
      PYTHONUNBUFFERED: "1"
      API_PORT: "8000"
      DATABASE_URL: "postgresql://clisonix:clisonix@postgres:5432/clisonixdb"
      REDIS_URL: "redis://redis:6379/0"
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # FRONTEND
  # ==========================
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    container_name: clisonix-web
    environment:
      NODE_ENV: "production"
      # Use Docker internal network for server-side API calls
      API_INTERNAL_URL: "http://clisonix-api:8000"
      # Client-side calls go through Nginx proxy
      NEXT_PUBLIC_API_BASE: "/api"
      # Clerk Authentication
      NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY: ${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
      CLERK_SECRET_KEY: ${CLERK_SECRET_KEY}
      NEXT_PUBLIC_CLERK_SIGN_IN_URL: "/sign-in"
      NEXT_PUBLIC_CLERK_SIGN_UP_URL: "/sign-up"
      NEXT_PUBLIC_CLERK_AFTER_SIGN_IN_URL: "/dashboard"
      NEXT_PUBLIC_CLERK_AFTER_SIGN_UP_URL: "/dashboard"
      # Stripe Payments
      NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
      # Kitchen API
      KITCHEN_JOBS_DIR: "/app/kitchen-jobs"
      KITCHEN_REPORTS_DIR: "/app/kitchen-reports"
      KITCHEN_RUN_API_KEY: ${KITCHEN_RUN_API_KEY:-clisonix-kitchen-secret}
    ports:
      - "3000:3000"
    volumes:
      # Share kitchen jobs/reports with worker
      - kitchen_jobs:/app/kitchen-jobs
      - kitchen_reports:/app/kitchen-reports
    depends_on:
      api:
        condition: service_healthy
    restart: unless-stopped

  # ==========================
  # VICTORIAMETRICS (Long-term Storage)
  # ==========================
  victoriametrics:
    image: victoriametrics/victoria-metrics:v1.96.0
    container_name: clisonix-victoriametrics
    ports:
      - "8428:8428"
    volumes:
      - ./data/victoriametrics:/victoria-metrics-data
    command:
      - "-storageDataPath=/victoria-metrics-data"
      - "-retentionPeriod=12"
      - "-httpListenAddr=0.0.0.0:8428"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:8428/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # ASI ENGINE (Artificial Super Intelligence)
  # ==========================
  asi:
    build:
      context: .
      dockerfile: Dockerfile.asi
    container_name: clisonix-asi
    environment:
      PYTHONUNBUFFERED: "1"
      REDIS_URL: "redis://redis:6379/0"
    ports:
      - "9094:9094"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9094/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # MARKETPLACE (API Keys, Billing, SaaS)
  # ==========================
  marketplace:
    build:
      context: .
      dockerfile: Dockerfile.marketplace
    container_name: clisonix-marketplace
    environment:
      PYTHONUNBUFFERED: "1"
      REDIS_URL: "redis://redis:6379/0"
      STRIPE_SECRET_KEY: "${STRIPE_SECRET_KEY}"
      STRIPE_PUBLISHABLE_KEY: "${STRIPE_PUBLISHABLE_KEY}"
      STRIPE_WEBHOOK_SECRET: "${STRIPE_WEBHOOK_SECRET}"
    ports:
      - "8004:8004"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # CONTENT FACTORY (Blerina + EAP + Publisher)
  # ==========================
  content-factory:
    build:
      context: .
      dockerfile: services/content-factory/Dockerfile
    container_name: clisonix-content-factory
    environment:
      PYTHONUNBUFFERED: "1"
      PORT: "8006"
      OLLAMA_HOST: "http://clisonix-ollama:11434"
      GITHUB_TOKEN: "${GITHUB_TOKEN}"
      BLOG_REPO_URL: "${BLOG_REPO_URL:-https://github.com/LedjanAhmati/clisonix-blog.git}"
    ports:
      - "8006:8006"
    depends_on:
      ollama:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # USER MANAGEMENT (Centralized User Registry)
  # ==========================
  user-management:
    build:
      context: ./services/user-management
      dockerfile: Dockerfile
    container_name: clisonix-user-management
    environment:
      PYTHONUNBUFFERED: "1"
      USER_MANAGEMENT_PORT: "8070"
    ports:
      - "8070:8070"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8070/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # INTELLIGENCE LAB (KLAJDI + MALI)
  # ==========================
  intelligence-lab:
    build:
      context: ./services/intelligence-lab
      dockerfile: Dockerfile
    container_name: clisonix-intelligence-lab
    environment:
      PYTHONUNBUFFERED: "1"
      INTELLIGENCE_LAB_PORT: "8099"
    ports:
      - "8099:8099"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8099/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # EXCEL MICROSERVICE
  # ==========================
  excel:
    build:
      context: ./services/excel
      dockerfile: Dockerfile
    container_name: clisonix-excel
    environment:
      PYTHONUNBUFFERED: "1"
      CORE_API_URL: "http://clisonix-api:8000"
    ports:
      - "8002:8002"
    volumes:
      - ./excel_files:/app/excel_files
      - ./uploads:/app/uploads
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # REPORTING (Excel, PowerPoint, Dashboard)
  # ==========================
  reporting:
    build:
      context: .
      dockerfile: Dockerfile.reporting
    container_name: clisonix-reporting
    environment:
      PYTHONUNBUFFERED: "1"
    ports:
      - "8001:8001"
    volumes:
      - ./reports:/app/reports
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # ECONOMY (Billing, Credits, Usage)
  # ==========================
  economy:
    build:
      context: .
      dockerfile: Dockerfile.economy
    container_name: clisonix-economy
    environment:
      PYTHONUNBUFFERED: "1"
      ECONOMY_API_PORT: "9093"
    ports:
      - "9093:9093"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9093/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # BEHAVIORAL SCIENCE (Mood, Habits, Focus Analytics)
  # ==========================
  behavioral:
    build:
      context: .
      dockerfile: Dockerfile.behavioral
    container_name: clisonix-behavioral
    environment:
      PYTHONUNBUFFERED: "1"
    ports:
      - "8003:8003"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # CYCLE ENGINE (Advanced Cycle Alignments)
  # ==========================
  cycle:
    build:
      context: .
      dockerfile: Dockerfile.cycle
    container_name: clisonix-cycle
    environment:
      PYTHONUNBUFFERED: "1"
      REDIS_URL: "redis://redis:6379/0"
    ports:
      - "8005:8005"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # NEUROSONIX (Industrial Neuroscience)
  # ==========================
  neurosonix:
    build:
      context: .
      dockerfile: Dockerfile.neurosonix
    container_name: clisonix-neurosonix
    environment:
      PYTHONUNBUFFERED: "1"
    ports:
      - "8006:8006"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8006/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # ADVANCED ANALYTICS (Data Science)
  # ==========================
  analytics:
    build:
      context: .
      dockerfile: Dockerfile.analytics
    container_name: clisonix-analytics
    environment:
      PYTHONUNBUFFERED: "1"
      DATABASE_URL: "postgresql://clisonix:clisonix@postgres:5432/clisonixdb"
    ports:
      - "8007:8007"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8007/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # SAAS ENGINE (SaaS Signal Processing)
  # ==========================
  saas:
    build:
      context: .
      dockerfile: Dockerfile.saas
    container_name: clisonix-saas
    environment:
      PYTHONUNBUFFERED: "1"
      REDIS_URL: "redis://redis:6379/0"
      SAAS_PORT: "8008"
    ports:
      - "8008:8008"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8008/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # HYBRID BIOMETRIC (Biometric Analysis)
  # ==========================
  biometric:
    build:
      context: .
      dockerfile: Dockerfile.biometric
    container_name: clisonix-biometric
    environment:
      PYTHONUNBUFFERED: "1"
    ports:
      - "8009:8009"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8009/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # USER DATA API (User Management)
  # ==========================
  userdata:
    build:
      context: .
      dockerfile: Dockerfile.userdata
    container_name: clisonix-userdata
    environment:
      PYTHONUNBUFFERED: "1"
      DATABASE_URL: "postgresql://clisonix:clisonix@postgres:5432/clisonixdb"
      REDIS_URL: "redis://redis:6379/0"
    ports:
      - "8010:8010"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # CURIOSITY OCEAN API (Knowledge Discovery)
  # ==========================
  curiosity:
    build:
      context: ./services/curiosity_ocean
      dockerfile: Dockerfile
    container_name: clisonix-curiosity
    environment:
      PYTHONUNBUFFERED: "1"
      OCEAN_CORE_URL: "http://clisonix-ocean-core:8030"
    ports:
      - "8011:8011"
    depends_on:
      - ocean-core
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # KNOWLEDGE INDEX (Search & Indexing)
  # ==========================
  knowledge:
    build:
      context: ./services/knowledge_index
      dockerfile: Dockerfile
    container_name: clisonix-knowledge
    environment:
      PYTHONUNBUFFERED: "1"
      REDIS_URL: "redis://redis:6379/0"
    ports:
      - "8012:8012"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8012/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

  # ==========================
  # INTELLIGENCE HUB (Central AI Coordinator)
  # DISABLED: Complex dependencies need refactoring
  # ==========================
  # intelligence:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.intelligence
  #   container_name: clisonix-intelligence
  #   environment:
  #     PYTHONUNBUFFERED: "1"
  #     ALBA_URL: "http://clisonix-alba:5555"
  #     ALBI_URL: "http://clisonix-albi:6680"
  #     ASI_URL: "http://clisonix-asi:9094"
  #     OCEAN_URL: "http://clisonix-ocean-core:8030"
  #   ports:
  #     - "8013:8013"
  #   depends_on:
  #     - alba
  #     - albi
  #     - asi
  #     - ocean-core
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8013/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   restart: unless-stopped

  # ==========================
  # INTERNAL AGI (Advanced General Intelligence)
  # DISABLED: Knowledge router needs refactoring
  # ==========================
  # agi:
  #   build:
  #     context: ./services/internal_agi
  #     dockerfile: Dockerfile
  #   container_name: clisonix-agi
  #   environment:
  #     PYTHONUNBUFFERED: "1"
  #     REDIS_URL: "redis://redis:6379/0"
  #   ports:
  #     - "8014:8014"
  #   depends_on:
  #     redis:
  #       condition: service_healthy
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8014/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #   restart: unless-stopped

  # ==========================
  # KITCHEN WORKER (Newman Test Runner)
  # ==========================
  kitchen-worker:
    build:
      context: ./services/kitchen-worker
      dockerfile: Dockerfile
    container_name: clisonix-kitchen-worker
    environment:
      NODE_ENV: "production"
      KITCHEN_JOBS_DIR: "/app/kitchen-jobs"
      KITCHEN_REPORTS_DIR: "/app/kitchen-reports"
      COLLECTIONS_DIR: "/app/postman-collections"
      POLL_INTERVAL_MS: "3000"
      MAX_CONCURRENT_JOBS: "2"
      HEALTH_PORT: "3100"
    ports:
      - "3100:3100"
    volumes:
      # Share jobs/reports with web container
      - kitchen_jobs:/app/kitchen-jobs
      - kitchen_reports:/app/kitchen-reports
      # Mount Postman collections from postman-collections folder only
      - ./postman-collections:/app/postman-collections:ro
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3100/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped

volumes:
  ollama_data:
    driver: local
  kitchen_jobs:
    driver: local
  kitchen_reports:
    driver: local

networks:
  default:
    driver: bridge
