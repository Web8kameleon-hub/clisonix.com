version: "3.9"

services:
  # ==========================
  # DATABASES / INFRA
  # ==========================
  postgres:
    image: postgres:16
    container_name: clisonix-postgres
    environment:
      POSTGRES_USER: clisonix
      POSTGRES_PASSWORD: clisonix
      POSTGRES_DB: clisonixdb
    ports:
      - "5432:5432"
    volumes:
      - ./data/postgres:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U clisonix"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: clisonix-redis
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ==========================
  # EXPORTERS - Database & Cache Monitoring
  # ==========================
  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:latest
    container_name: clisonix-postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://clisonix:clisonix@postgres:5432/clisonixdb?sslmode=disable"
    ports:
      - "9187:9187"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9187/metrics"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  redis-exporter:
    image: oliver006/redis_exporter:latest
    container_name: clisonix-redis-exporter
    environment:
      REDIS_ADDR: redis:6379
    ports:
      - "9121:9121"
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9121/metrics"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  minio:
    image: minio/minio:latest
    container_name: clisonix-minio
    command: server /data
    environment:
      MINIO_ROOT_USER: clisonix
      MINIO_ROOT_PASSWORD: clisonix-secret
    volumes:
      - ./data/minio:/data
    ports:
      - "9000:9000"
    restart: unless-stopped

  # ==========================
  # METRICS & MONITORING (VictoriaMetrics - 10x faster than Prometheus)
  # ==========================
  victoria-metrics:
    image: victoriametrics/victoria-metrics:latest
    container_name: clisonix-victoria-metrics
    command:
      - "-storageDataPath=/victoria-metrics-data"
      - "-retentionPeriod=90d"
      - "-memory.allowedPercent=60"
    ports:
      - "8428:8428"
    volumes:
      - ./data/victoria-metrics:/victoria-metrics-data
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:8428/health"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  loki:
    image: grafana/loki:2.9.5
    container_name: clisonix-loki
    command:
      - "-config.file=/etc/loki/config.yaml"
    ports:
      - "3100:3100"
    volumes:
      - ./ops/loki/config.yaml:/etc/loki/config.yaml
      - ./data/loki:/loki
    restart: unless-stopped

  vmalert:
    image: victoriametrics/vmalert:latest
    container_name: clisonix-vmalert
    ports:
      - "8880:8880"
    command:
      - "-datasource=http://victoria-metrics:8428"
      - "-notifier.url=http://alertmanager:9093"
      - "-remoteRead.url=http://victoria-metrics:8428"
      - "-remoteWrite.url=http://victoria-metrics:8428"
      - "-rule=/etc/vmalert/rules.yml"
    volumes:
      - ./ops/vmalert-rules.yml:/etc/vmalert/rules.yml
    depends_on:
      - victoria-metrics
      - alertmanager
    restart: unless-stopped

  prometheus:
    image: prom/prometheus:latest
    container_name: clisonix-prometheus-collector
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.path=/prometheus"
      - "--query.max-concurrency=20"
    volumes:
      - ./ops/prometheus-victoria.yml:/etc/prometheus/prometheus.yml
      - ./ops/alert-rules.yml:/etc/prometheus/alert-rules.yml
      - ./data/prometheus:/prometheus
    ports:
      - "3005:9090"
    depends_on:
      - victoria-metrics
    restart: unless-stopped

  alertmanager:
    image: prom/alertmanager:latest
    container_name: clisonix-alertmanager
    ports:
      - "9093:9093"
    volumes:
      - ./ops/alertmanager.yml:/etc/alertmanager/alertmanager.yml
      - ./data/alertmanager:/alertmanager
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
      - "--storage.path=/alertmanager"
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: clisonix-grafana
    ports:
      - "3004:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: clisonix123
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - ./data/grafana:/var/lib/grafana
      - ./ops/grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - prometheus
      - loki
      - tempo
    restart: unless-stopped

  # ==========================
  # ELASTICSEARCH + KIBANA (Advanced Logging)
  # ==========================
  elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
    container_name: clisonix-elasticsearch
    environment:
      discovery.type: single-node
      xpack.security.enabled: "true"
      xpack.security.enrollment.enabled: "true"
      ELASTIC_PASSWORD: clisonix123
      ES_JAVA_OPTS: "-Xms512m -Xmx512m"
    ports:
      - "9200:9200"
    volumes:
      - ./data/elasticsearch:/usr/share/elasticsearch/data
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:9200 | grep -q cluster_name || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  kibana:
    image: docker.elastic.co/kibana/kibana:8.11.0
    container_name: clisonix-kibana
    ports:
      - "5601:5601"
    environment:
      ELASTICSEARCH_HOSTS: "http://elasticsearch:9200"
      ELASTICSEARCH_USERNAME: elastic
      ELASTICSEARCH_PASSWORD: clisonix123
      xpack.security.enabled: "true"
    depends_on:
      - elasticsearch
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:5601/api/status | grep -q state || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  filebeat:
    image: docker.elastic.co/beats/filebeat:8.11.0
    container_name: clisonix-filebeat
    user: root
    command: filebeat -e -strict.perms=false
    volumes:
      - ./ops/filebeat.yml:/usr/share/filebeat/filebeat.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      ELASTICSEARCH_HOSTS: "elasticsearch:9200"
      ELASTICSEARCH_USERNAME: elastic
      ELASTICSEARCH_PASSWORD: clisonix123
    depends_on:
      - elasticsearch
    restart: unless-stopped

  # ==========================
  # DISTRIBUTED TRACING
  # ==========================
  tempo:
    image: grafana/tempo:latest
    container_name: clisonix-tempo
    command: ["-config.file=/etc/tempo.yaml"]
    volumes:
      - ./data/tempo:/var/tempo
      - ./tempo.yaml:/etc/tempo.yaml
    ports:
      - "4318:4318"   # OTLP HTTP ingest
      - "4317:4317"   # OTLP gRPC ingest
      - "3200:3200"   # Tempo Query API
    environment:
      PYTHONUNBUFFERED: "1"
    networks:
      - clisonix-network
    restart: unless-stopped

  # ==========================
  # SAAS SERVICES
  # ==========================
  alba:
    image: python:3.13
    container_name: clisonix-alba
    working_dir: /app
    volumes:
      - ./:/app
    command: ["sh", "-c", "pip install -q -r requirements.txt && python alba_service_5555.py"]
    environment:
      PYTHONUNBUFFERED: "1"
      PORT: "5050"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "5050:5050"
    networks:
      - clisonix-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5050/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  albi:
    image: python:3.13
    container_name: clisonix-albi
    working_dir: /app
    volumes:
      - ./:/app
    command: ["sh", "-c", "pip install -q -r requirements.txt && python albi_service_6666.py"]
    environment:
      PYTHONUNBUFFERED: "1"
      PORT: "6060"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "6060:6060"
    networks:
      - clisonix-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6060/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  jona:
    image: python:3.13
    container_name: clisonix-jona
    working_dir: /app
    volumes:
      - ./:/app
    command: ["sh", "-c", "pip install -q -r requirements.txt && python jona_service_7777.py"]
    environment:
      PYTHONUNBUFFERED: "1"
      PORT: "7070"
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - "7070:7070"
    networks:
      - clisonix-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7070/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  orchestrator:
    image: python:3.13
    container_name: clisonix-orchestrator
    working_dir: /app
    volumes:
      - ./:/app
    command: ["sh", "-c", "pip install -q -r requirements.txt && python saas_services_orchestrator_v3.py"]
    environment:
      PYTHONUNBUFFERED: "1"
      SERVICE_ALBA_HOST: "alba"
      SERVICE_ALBI_HOST: "albi"
      SERVICE_JONA_HOST: "jona"
    depends_on:
      alba:
        condition: service_started
      albi:
        condition: service_started
      jona:
        condition: service_started
    ports:
      - "9999:9999"
    networks:
      - clisonix-network
    restart: unless-stopped

  # ==========================
  # API BACKEND
  # ==========================
  api:
    build:
      context: .
      dockerfile: Dockerfile.api
    container_name: clisonix-api
    environment:
      PYTHONUNBUFFERED: "1"
      DATABASE_URL: "postgresql://clisonix:clisonix@postgres:5432/clisonixdb"
      REDIS_URL: "redis://redis:6379/0"
    depends_on:
      postgres:
        condition: service_healthy
      orchestrator:
        condition: service_started
    ports:
      - "3003:8000"
    networks:
      - clisonix-network
    restart: unless-stopped

  # ==========================
  # SLACK INTEGRATION
  # ==========================
  slack:
    image: python:3.13
    container_name: clisonix-slack
    working_dir: /app
    volumes:
      - ./:/app
    command: ["sh", "-c", "pip install -q -r requirements.txt && python slack_integration_service.py"]
    environment:
      PYTHONUNBUFFERED: "1"
      SLACK_WEBHOOK_URL: "${SLACK_WEBHOOK_URL}"
      SLACK_CHANNEL: "${SLACK_CHANNEL:-#clisonix-monitoring}"
      SERVICE_MODE: "production"
      SLACK_PORT: "8888"
    depends_on:
      api:
        condition: service_started
    ports:
      - "8888:8888"
    restart: unless-stopped

  # ==========================
  # NGINX REVERSE PROXY
  # ==========================
  nginx:
    image: nginx:alpine
    container_name: clisonix-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - api
      - web
      - grafana
    networks:
      - clisonix-network
    restart: unless-stopped

  # ==========================
  # FRONTEND (Next.js, prod)
  # ==========================
  web:
    image: node:22
    container_name: clisonix-web
    working_dir: /app
    volumes:
      - ./apps/web:/app
    environment:
      NODE_ENV: "production"
      NEXT_PUBLIC_API_BASE: "http://api:8000"
      NEXT_PUBLIC_ORCHESTRATOR_URL: "http://orchestrator:9999"
    command: ["sh", "-c", "npm install && npm run build && npm run start"]
    depends_on:
      api:
        condition: service_started
    ports:
      - "3002:3000"
    networks:
      - clisonix-network
    restart: unless-stopped

networks:
  clisonix-network:
    driver: bridge

